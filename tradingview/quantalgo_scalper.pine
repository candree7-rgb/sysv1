// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0
// SMC Scalper Pro - HIGH QUALITY SIGNALS ONLY
//@version=6
strategy("SMC Scalper Pro", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10, initial_capital=10000, commission_type=strategy.commission.percent, commission_value=0.06, process_orders_on_close=true)

//=============================================================================
// INPUTS
//=============================================================================
grp_bias = "Trend Filter (STRICT)"
i_ema_fast      = input.int(21, "Fast EMA", minval=5, maxval=50, group=grp_bias)
i_ema_slow      = input.int(50, "Slow EMA", minval=20, maxval=200, group=grp_bias)
i_ema_sep       = input.float(0.5, "Min EMA Separation %", minval=0.1, maxval=2.0, step=0.1, group=grp_bias, tooltip="EMAs must be this far apart = clear trend")

grp_signal = "Signal Quality"
i_min_candle    = input.float(1.5, "Min Candle Size (ATR)", minval=0.5, maxval=3.0, step=0.1, group=grp_signal, tooltip="Only big impulsive candles")
i_vol_mult      = input.float(1.2, "Min Volume Multiplier", minval=1.0, maxval=3.0, step=0.1, group=grp_signal, tooltip="Volume must be above average")
i_rsi_ob        = input.int(70, "RSI Overbought", minval=60, maxval=90, group=grp_signal)
i_rsi_os        = input.int(30, "RSI Oversold", minval=10, maxval=40, group=grp_signal)

grp_risk = "Risk Management"
i_sl_pct        = input.float(1.0, "SL %", minval=0.1, maxval=5.0, step=0.1, group=grp_risk)
i_tp_rr         = input.float(2.0, "TP Risk:Reward", minval=1.0, maxval=5.0, step=0.1, group=grp_risk)
i_cooldown      = input.int(20, "Cooldown Bars", minval=5, maxval=100, group=grp_risk)

grp_display = "Display"
i_show_table    = input.bool(true, "Show Performance Table", group=grp_display)

//=============================================================================
// INDICATORS
//=============================================================================
emaFast = ta.ema(close, i_ema_fast)
emaSlow = ta.ema(close, i_ema_slow)
atr = ta.atr(14)
rsi = ta.rsi(close, 14)
avgVol = ta.sma(volume, 20)

//=============================================================================
// TREND DETECTION - Must have CLEAR trend (EMA separation)
//=============================================================================
emaSeparation = math.abs(emaFast - emaSlow) / close * 100
clearTrend = emaSeparation >= i_ema_sep

bullTrend = emaFast > emaSlow and clearTrend
bearTrend = emaFast < emaSlow and clearTrend

//=============================================================================
// SIGNAL QUALITY FILTERS
//=============================================================================
candleSize = math.abs(close - open)
bigCandle = candleSize > atr * i_min_candle
highVolume = volume > avgVol * i_vol_mult

// Bullish signal: Big green candle, after red candle, with volume, RSI not overbought
bullCandle = close > open and bigCandle and highVolume and close[1] < open[1]
bullRsiOK = rsi < i_rsi_ob and rsi > 40  // Not overbought, not too weak

// Bearish signal: Big red candle, after green candle, with volume, RSI not oversold
bearCandle = close < open and bigCandle and highVolume and close[1] > open[1]
bearRsiOK = rsi > i_rsi_os and rsi < 60  // Not oversold, not too strong

//=============================================================================
// COOLDOWN
//=============================================================================
var int barsSinceExit = 999
if strategy.position_size == 0 and strategy.position_size[1] != 0
    barsSinceExit := 0
else if strategy.position_size == 0
    barsSinceExit := barsSinceExit + 1

cooldownOK = barsSinceExit >= i_cooldown

//=============================================================================
// FINAL SIGNALS - ALL CONDITIONS MUST BE TRUE
//=============================================================================
longSignal = bullTrend and bullCandle and bullRsiOK and cooldownOK and strategy.position_size == 0
shortSignal = bearTrend and bearCandle and bearRsiOK and cooldownOK and strategy.position_size == 0

//=============================================================================
// POSITION STATE
//=============================================================================
var float entry_price = na
var float sl_price = na
var float tp_price = na

//=============================================================================
// ENTRIES
//=============================================================================
if longSignal
    entry_price := close
    sl_distance = close * (i_sl_pct / 100)
    sl_price := close - sl_distance
    tp_price := close + (sl_distance * i_tp_rr)
    strategy.entry("Long", strategy.long)

if shortSignal
    entry_price := close
    sl_distance = close * (i_sl_pct / 100)
    sl_price := close + sl_distance
    tp_price := close - (sl_distance * i_tp_rr)
    strategy.entry("Short", strategy.short)

//=============================================================================
// FALLBACK
//=============================================================================
just_entered = strategy.position_size != 0 and strategy.position_size[1] == 0
if just_entered and na(sl_price)
    entry_price := strategy.position_avg_price
    sl_distance = entry_price * (i_sl_pct / 100)
    if strategy.position_size > 0
        sl_price := entry_price - sl_distance
        tp_price := entry_price + (sl_distance * i_tp_rr)
    else
        sl_price := entry_price + sl_distance
        tp_price := entry_price - (sl_distance * i_tp_rr)

//=============================================================================
// EXIT WITH GAP PROTECTION
//=============================================================================
if strategy.position_size > 0 and not na(sl_price) and not na(tp_price)
    if open < sl_price
        strategy.close("Long", comment="SL Gap")
    else
        strategy.exit("XL", "Long", limit=tp_price, stop=sl_price)

if strategy.position_size < 0 and not na(sl_price) and not na(tp_price)
    if open > sl_price
        strategy.close("Short", comment="SL Gap")
    else
        strategy.exit("XS", "Short", limit=tp_price, stop=sl_price)

//=============================================================================
// RESET
//=============================================================================
if strategy.position_size == 0 and strategy.position_size[1] != 0
    entry_price := na
    sl_price := na
    tp_price := na

//=============================================================================
// VISUALS
//=============================================================================
plotshape(longSignal, "Long", shape.triangleup, location.belowbar, color.lime, size=size.normal)
plotshape(shortSignal, "Short", shape.triangledown, location.abovebar, color.red, size=size.normal)

plot(emaFast, "EMA Fast", color.new(color.blue, 30), 2)
plot(emaSlow, "EMA Slow", color.new(color.orange, 30), 2)

plot(strategy.position_size != 0 ? entry_price : na, "Entry", color.blue, 1, plot.style_linebr)
plot(strategy.position_size != 0 ? tp_price : na, "TP", color.green, 2, plot.style_linebr)
plot(strategy.position_size != 0 ? sl_price : na, "SL", color.red, 2, plot.style_linebr)

// Trend background
bgcolor(bullTrend ? color.new(color.green, 95) : bearTrend ? color.new(color.red, 95) : na)

//=============================================================================
// PERFORMANCE TABLE
//=============================================================================
var table perfTable = table.new(position.top_right, 2, 12, bgcolor=color.new(color.black, 80), border_width=1, border_color=color.gray)

if i_show_table and barstate.islast
    wins = strategy.wintrades
    losses = strategy.losstrades
    total = strategy.closedtrades
    winRate = total > 0 ? wins / total * 100 : 0
    profitFactor = strategy.grossloss != 0 ? strategy.grossprofit / math.abs(strategy.grossloss) : 0
    maxDD = strategy.max_drawdown / strategy.initial_capital * 100
    netProfitPct = strategy.netprofit / strategy.initial_capital * 100

    table.cell(perfTable, 0, 0, "SMC SCALPER PRO", text_color=color.white, bgcolor=color.new(color.blue, 50), text_size=size.small)
    table.cell(perfTable, 1, 0, "v2.0", text_color=color.white, bgcolor=color.new(color.blue, 50), text_size=size.small)

    trendStr = bullTrend ? "BULL" : bearTrend ? "BEAR" : "NONE"
    trendCol = bullTrend ? color.green : bearTrend ? color.red : color.gray
    table.cell(perfTable, 0, 1, "Trend", text_color=color.gray, text_size=size.small)
    table.cell(perfTable, 1, 1, trendStr, text_color=trendCol, text_size=size.small)

    table.cell(perfTable, 0, 2, "EMA Sep", text_color=color.gray, text_size=size.small)
    table.cell(perfTable, 1, 2, str.tostring(emaSeparation, "#.##") + "%", text_color=clearTrend ? color.green : color.red, text_size=size.small)

    table.cell(perfTable, 0, 3, "Total Trades", text_color=color.gray, text_size=size.small)
    table.cell(perfTable, 1, 3, str.tostring(total), text_color=color.white, text_size=size.small)

    table.cell(perfTable, 0, 4, "W / L", text_color=color.gray, text_size=size.small)
    table.cell(perfTable, 1, 4, str.tostring(wins) + " / " + str.tostring(losses), text_color=color.white, text_size=size.small)

    table.cell(perfTable, 0, 5, "Win Rate", text_color=color.gray, text_size=size.small)
    wrColor = winRate >= 55 ? color.green : winRate >= 45 ? color.yellow : color.red
    table.cell(perfTable, 1, 5, str.tostring(winRate, "#.#") + "%", text_color=wrColor, text_size=size.small)

    table.cell(perfTable, 0, 6, "Profit Factor", text_color=color.gray, text_size=size.small)
    pfColor = profitFactor >= 1.5 ? color.green : profitFactor >= 1.0 ? color.yellow : color.red
    table.cell(perfTable, 1, 6, str.tostring(profitFactor, "#.##"), text_color=pfColor, text_size=size.small)

    table.cell(perfTable, 0, 7, "Max DD", text_color=color.gray, text_size=size.small)
    table.cell(perfTable, 1, 7, str.tostring(maxDD, "#.#") + "%", text_color=color.red, text_size=size.small)

    tpPct = i_sl_pct * i_tp_rr
    table.cell(perfTable, 0, 8, "SL / TP", text_color=color.gray, text_size=size.small)
    table.cell(perfTable, 1, 8, str.tostring(i_sl_pct, "#.#") + "% / " + str.tostring(tpPct, "#.#") + "%", text_color=color.aqua, text_size=size.small)

    table.cell(perfTable, 0, 9, "RSI", text_color=color.gray, text_size=size.small)
    rsiCol = rsi > i_rsi_ob ? color.red : rsi < i_rsi_os ? color.green : color.white
    table.cell(perfTable, 1, 9, str.tostring(rsi, "#.#"), text_color=rsiCol, text_size=size.small)

    table.cell(perfTable, 0, 10, "Net Profit", text_color=color.gray, text_size=size.small)
    npColor = strategy.netprofit >= 0 ? color.green : color.red
    table.cell(perfTable, 1, 10, str.tostring(netProfitPct, "#.#") + "%", text_color=npColor, text_size=size.small)

    table.cell(perfTable, 0, 11, "Status", text_color=color.gray, text_size=size.small)
    posStatus = strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : "FLAT"
    posColor = strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray
    table.cell(perfTable, 1, 11, posStatus, text_color=posColor, text_size=size.small)

//=============================================================================
// ALERTS
//=============================================================================
alertcondition(longSignal, title="Long Entry", message="SMC Scalper: HIGH QUALITY Long Signal")
alertcondition(shortSignal, title="Short Entry", message="SMC Scalper: HIGH QUALITY Short Signal")
